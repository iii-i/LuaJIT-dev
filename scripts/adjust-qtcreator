#!/usr/bin/env python3
import argparse
import os
import re
import xml.etree.ElementTree as ET
from configparser import ConfigParser
from pathlib import Path

QT_CONFIG_DIR = Path.home() / ".config" / "QtProject"


def get_environment_id():
    config = ConfigParser()
    config.read(QT_CONFIG_DIR / "QtCreator.ini")
    raw_value = config["ProjectExplorer"]["Settings\\EnvironmentId"]
    prefix = "@ByteArray("
    suffix = ")"
    if not (raw_value.startswith(prefix) and raw_value.endswith(suffix)):
        raise RuntimeError("Malformed ProjectExplorer.Settings\\EnvironmentId")
    return raw_value[len(prefix) : -len(suffix)]


def get_default_profile_id():
    tree = ET.parse(QT_CONFIG_DIR / "qtcreator" / "profiles.xml")
    root = tree.getroot()
    for data in root.findall("data"):
        variable = data.find("variable")
        if variable is not None and variable.text == "Profile.Default":
            return data.find("value").text
    raise RuntimeError("Profile.Default is missing")


def update_user_file(user_file_path, environment_id, profile_id):
    tree = ET.parse(user_file_path)
    root = tree.getroot()
    for data in root.findall("data"):
        variable = data.find("variable")
        if variable is None:
            continue
        if variable.text == "EnvironmentId":
            value = data.find("value")
            if value is not None:
                value.text = environment_id
        elif variable.text.startswith("ProjectExplorer.Project.Target."):
            valuemap = data.find("valuemap")
            if valuemap is not None:
                for value in valuemap.findall("value"):
                    if value.get("key") == "ProjectExplorer.ProjectConfiguration.Id":
                        value.text = profile_id
    tree.write(user_file_path)


def main():
    parser = argparse.ArgumentParser(
        description="Adapt a QtCreator .user file to local machine configuration."
    )
    parser.add_argument(
        "user_file",
        help="Path to the .user file",
        nargs="?",
        default="compile_commands.json.user",
    )
    args = parser.parse_args()
    environment_id = get_environment_id()
    profile_id = get_default_profile_id()
    update_user_file(Path(args.user_file), environment_id, profile_id)


if __name__ == "__main__":
    main()
